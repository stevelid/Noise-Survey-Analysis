# Claude AI Assistant Guide - Noise Survey Analysis

## Quick Reference
This project is a **Bokeh-based data visualization application** with a **Redux-inspired unidirectional data flow architecture**.

### üî¥ Critical: Read First
**Full architectural documentation:** See `AGENTS.md` for complete handbook covering:
- Core architectural principles (Redux-style state management)
- Layer responsibilities (event handlers ‚Üí thunks ‚Üí actions ‚Üí reducers ‚Üí selectors/renderers)
- Naming conventions and code organization
- UI State vs Data Cache separation
- Bokeh-specific constraints and patterns
- Testing strategy and manual test checklist maintenance

### Architecture Summary
```
User Interaction ‚Üí Event Handler ‚Üí Thunk ‚Üí Action ‚Üí Reducer ‚Üí State Update
                                                                    ‚Üì
                                                            onStateChange
                                                                    ‚Üì
                                                    Data Processors (mutate cache)
                                                                    ‚Üì
                                                    Renderers (update Bokeh UI)
```

### Key Principles
1. **Single Source of Truth:** `app.store` is immutable UI state
2. **Data Cache:** Separate mutable cache for large arrays (`dataCache`)
3. **Strict Layer Separation:** Logic must go in the correct layer (see AGENTS.md ¬ß2)
4. **No Magic Values:** Use constants, not hardcoded strings/numbers
5. **Manual Test Checklist:** MUST update `tests/MANUAL_TEST_CHECKLIST.md` for any UI interaction changes

### File Structure
- **JavaScript:** `noise_survey_analysis/static/js/`
  - `core/` - actions, reducers, store, selectors
  - `features/` - feature-specific logic (thunks, reducers, selectors)
  - `services/` - event handlers, renderers
  - `utils/` - pure utility functions
  - `data-processors.js` - data slicing and cache management
  - `app.js` - application initialization and orchestration

- **Python:** `noise_survey_analysis/`
  - `core/` - app setup, callbacks, config, data management
  - `ui/` - Bokeh UI components
  - `visualization/` - chart components
  - `export/` - static HTML generation

### Common Patterns

#### Adding a New User Interaction
1. Add event handler in `services/eventHandlers.js` (thin, just normalize event)
2. Create thunk in `features/*/thunks.js` (business logic)
3. Define action in `core/actions.js` (plain object)
4. Handle in reducer (pure state update)
5. Update renderer in `services/renderers.js` (sync UI)
6. **CRITICAL:** Update `tests/MANUAL_TEST_CHECKLIST.md` with test cases

#### Bokeh ColumnDataSource Updates
- **Full replacement:** `source.data = { col1: [...], col2: [...] }` (auto-triggers update)
- **In-place modification:** `source.data.col[0] = newValue; source.change.emit();`
- **Image data:** Must be 2D TypedArray, fixed size after initialization

#### Accessing Time Series Data
```javascript
// ‚úÖ Correct
const source = models?.timeSeriesSources?.[positionId]?.overview;

// ‚ùå Wrong
const source = registry.models.timeSeriesSources[positionId].overview;
```

### Application Launch Modes & Data Loading

The application supports **three launch modes** and **three data loading methods**:

#### Launch Modes

**1. Live Interactive Server (Development/Analysis)**
```bash
bokeh serve noise_survey_analysis --show
```
- Full interactivity with real-time updates
- Audio playback support
- State persistence and workspace saving
- Automatic data caching across sessions
- Best for: Active analysis, annotation, exploration

**2. Static HTML Export (Sharing/Archiving)**
```bash
python -m noise_survey_analysis.main --generate-static .\config.json
```
- Generates standalone HTML file with embedded data
- No server required, works offline
- Limited interactivity (no audio, no state saving)
- Best for: Reports, sharing with non-technical users

**3. Auto-Export Mode (Live + Background Export)**
- Automatically triggered when using data source selector in live mode
- Generates static HTML in background thread while live server runs
- Config auto-saved to `noise_survey_analysis/export/last_selected_config.json`

#### Data Loading Methods

**Method 1: Config File (Recommended for Known Datasets)**
```bash
# Load from config.json
bokeh serve noise_survey_analysis --show --args --config .\config.json

# Alternative syntax
bokeh serve noise_survey_analysis --show --args .\config.json
```

**Config File Format:**
```json
{
  "version": "1.2",
  "config_base_path": "G:/path/to/survey/data",
  "output_filename": "dashboard.html",
  "sources": [
    {
      "path": "subfolder/data_log.csv",
      "position": "L419",
      "type": "Svan",
      "parser_type": "svan"
    },
    {
      "path": "subfolder/audio_folder",
      "position": "L419",
      "type": "Audio",
      "parser_type": "audio"
    }
  ]
}
```

**Method 2: Workspace File (Restore Full Session State)**
```bash
bokeh serve noise_survey_analysis --show --args --state .\saved_workspace.json
# or --workspace, --savedworkspace
```

**Workspace File Format:**
```json
{
  "sourceConfigs": [
    {
      "position_name": "L419",
      "file_paths": ["G:/full/path/to/file1.csv", "G:/full/path/to/file2.csv"],
      "audio_paths": ["G:/full/path/to/audio"]
    }
  ],
  "appState": {
    "regions": [...],
    "viewport": {...},
    "selectedParameter": "LZeq",
    "audio": {...}
  }
}
```
- Restores **both data sources AND UI state** (regions, zoom, selections)
- Generated via "Save Workspace" button in live app
- Best for: Resuming analysis sessions

**Method 3: Interactive Selector (No Config)**
```bash
bokeh serve noise_survey_analysis --show
```
- Shows file browser UI on startup
- Select CSV files and audio folders interactively
- Auto-generates config and triggers background static export
- Best for: First-time use, exploring new datasets

#### Data Caching System

**Process-Level Cache:**
- `DataManager` instances cached by source configuration fingerprint
- Cache persists across Bokeh sessions and module reloads
- Stored in temp directory: `noise_survey_datamanager_cache.pkl`
- **Cache key:** Generated from sorted, normalized file paths + position names
- **Cache hit:** Instant dashboard load (no CSV parsing)
- **Cache miss:** Full data parsing, then cached for next time

**When Cache is Used:**
- Same config file loaded multiple times
- Same workspace restored
- Bokeh auto-reload during development
- Multiple browser sessions to same data

**Cache Invalidation:**
- Automatic if source files change (different paths)
- Manual: Delete `noise_survey_datamanager_cache.pkl` from temp directory

#### Argument Parsing Priority

The app checks for config/workspace paths in this order:
1. URL query parameters: `?config=path` or `?state=path`
2. Bokeh `--args` flags: `--config path` or `--state path`
3. Positional argument: `bokeh serve ... --args path/to/file.json`
4. If none found: Show interactive selector

#### Common Launch Scenarios

```bash
# Quick start with known config
bokeh serve noise_survey_analysis --show --args --config .\config.json

# Resume saved analysis session
bokeh serve noise_survey_analysis --show --args --workspace .\my_analysis.json

# Explore new dataset interactively
bokeh serve noise_survey_analysis --show

# Generate report for sharing
python -m noise_survey_analysis.main --generate-static .\config.json

# Development with auto-reload
bokeh serve noise_survey_analysis --show --dev --args --config .\config.json
```

### Testing Commands
```bash
# Run automated tests
npm test

# E2E tests with Playwright
npx playwright test
```

### Before Making Changes
- [ ] Identify which architectural layer(s) are affected
- [ ] Check if selectors exist for needed state access
- [ ] Verify naming conventions (see AGENTS.md ¬ß3)
- [ ] Plan reducer updates (must be pure, immutable)
- [ ] Consider if manual test checklist needs updates

### Common Pitfalls to Avoid
1. ‚ùå Mutating state directly in reducers
2. ‚ùå Business logic in event handlers or renderers
3. ‚ùå Dispatching actions from renderers
4. ‚ùå Accessing `registry.models` directly in thunks
5. ‚ùå Changing Bokeh image buffer dimensions after initialization
6. ‚ùå Forgetting to update manual test checklist for UI changes
7. ‚ùå Hardcoding values that should be constants

### When in Doubt
1. Read the relevant section in `AGENTS.md`
2. Look for similar existing patterns in the codebase
3. Check `tests/MANUAL_TEST_CHECKLIST.md` for interaction examples
4. Verify changes don't break the unidirectional data flow

---
**Remember:** This is a specialized Bokeh application with strict architectural patterns. Always consult `AGENTS.md` for detailed guidance before implementing features.
